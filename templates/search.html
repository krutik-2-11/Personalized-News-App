<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ q|title }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
  <style>
    .summary-card{background:#0b1222;border:1px solid #27324a}
    .summary-card .card-title{color:#f3f4f6}
    .summary-md{color:#f8fafc;line-height:1.7;font-size:1.06rem}
    .summary-md h3,.summary-md h4,.summary-md h5{color:#ffffff;margin-top:.5rem;margin-bottom:.25rem}
    .summary-md ul{margin:0 0 .25rem 1.2rem}
    .skeleton{height:110px;border-radius:.5rem;
      background:linear-gradient(90deg,#1f2937 25%,#2c3648 37%,#1f2937 63%);background-size:400% 100%;
      animation:shimmer 1.1s infinite}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:0 0}}
  </style>
</head>
<body class="bg-slate text-slate">
  <div class="container py-3">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h3 class="m-0">üîé {{ q|title }}</h3>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-light btn-sm" href="{{ url_for('focused.focus_home') }}">‚Üê Focus</a>
        <a class="btn btn-outline-light btn-sm" href="{{ url_for('index') }}">Home</a>
      </div>
    </div>

    <div class="card summary-card mb-4">
      <div class="card-body">
        <h5 class="card-title mb-2">What‚Äôs going on</h5>
        <div id="summary" class="summary-md"><div class="skeleton"></div></div>
        <div id="notice" class="text-secondary small mt-2"></div>
      </div>
    </div>

    <h6 class="mb-2">Latest from credible sources</h6>
    {% if items %}
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
        {% for a in items %}
          <div class="col">
            <div class="card h-100">
              <div class="card-body d-flex flex-column">
                <a class="stretched-link" href="{{ a.link }}" target="_blank" rel="noopener">
                  <h6 class="card-title">{{ a.title }}</h6>
                </a>
                {% if a.summary %}<p class="card-text mt-2">{{ a.summary[:220] }}{% if a.summary|length > 220 %}‚Ä¶{% endif %}</p>{% endif %}
                <div class="mt-auto d-flex justify-content-between">
                  <div class="source">{{ a.domain or a.source }}</div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-secondary">No recent articles found.</div>
    {% endif %}
  </div>

  <!-- Safe Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.1/marked.min.js"></script>
  <script>
    (async () => {
      const params = new URLSearchParams({
        q: "{{ q }}",
        finance: "{{ 1 if finance else 0 }}",
        mode: "{{ 'llm' if session.get('summary_mode','extractive') == 'llm' else 'extractive' }}"
      });
      try{
        const resp = await fetch(`/api/summarize?${params.toString()}`);
        const data = await resp.json();
        const md = data.summary || "No summary available.";
        const html = DOMPurify.sanitize(marked.parse(md));
        document.getElementById("summary").innerHTML = html;
        document.getElementById("notice").textContent =
          data.cached ? "‚ö° loaded from cache" : (data.used_llm ? "LLM summary" : "Fast summary");
      }catch(e){
        document.getElementById("summary").textContent = "No summary available.";
        document.getElementById("notice").textContent = "Failed to fetch summary.";
      }
    })();
  </script>
</body>
</html>
